name: Deploy AWS Lambda apne1

on:
#   push:
#     paths:
#       - 'RequestEngine/aws/lambda/py/funcfiles/**'
#       - 'RequestEngine/funcfiles/common/py/**'
#     branches:
#       - main
  workflow_dispatch:
    inputs:
      ext_security:
        description: 'Enable security extension (eo.security.*)'
        required: false
        default: true
        type: boolean

permissions:
  id-token: write # Required for OIDC authentication
  contents: read  # Required for repository read

# Request Engine Instance config: ../../RequestEngine/aws/lambda/py/instances_conf/lambda001.env
# Resource name pattern: eo-re-d1-lambda-{re_region_short}
env:
  PYTHON_VERSION: "3.14"
  LAMBDA_FUNCTION_NAME: eo-re-d1-lambda-apne1

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # 1. Create deployment package by merging modular source files
      - name: Merge Lambda Function Files
        run: |
          mkdir -p deploy_package
          SRC_DIR="RequestEngine/aws/lambda/py/funcfiles"
          COMMON_DIR="RequestEngine/funcfiles/common/py"
          EXT_DIR="RequestEngine/funcfiles/common/py/extensions"

          # Create header comment
          {
            echo "# ----------------------------------------------------"
            echo "# AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY"
            echo "# ----------------------------------------------------"
            echo "# This file is automatically generated during deployment by merging:"
            echo "# 1. _01_imports.py (common imports)"
            echo "# 2. request_engine_core.py (shared core functions)"
            echo "# 3. extensions/_ext_*.py (extension modules)"
            echo "# 4. _03_aws_lambda_handler.py (AWS Lambda specific code)"
            echo "#"
            echo "# To make changes, edit the source files and redeploy."
            echo "# ----------------------------------------------------"
            echo ""
          } > deploy_package/lambda_function.py

          # 1. Append common imports
          echo "# ======================================================================" >> deploy_package/lambda_function.py
          echo "# Section 1: Common Imports" >> deploy_package/lambda_function.py
          echo "# ======================================================================" >> deploy_package/lambda_function.py
          cat "$SRC_DIR/_01_imports.py" >> deploy_package/lambda_function.py
          echo "" >> deploy_package/lambda_function.py

          # 2. Append common core code (shared across all platforms)
          echo "# ======================================================================" >> deploy_package/lambda_function.py
          echo "# Section 2: Request Engine Core (Shared Code)" >> deploy_package/lambda_function.py
          echo "# ======================================================================" >> deploy_package/lambda_function.py
          cat "$COMMON_DIR/request_engine_core.py" >> deploy_package/lambda_function.py
          echo "" >> deploy_package/lambda_function.py

          # 3. Append extension modules (only enabled ones)
          echo "# ======================================================================" >> deploy_package/lambda_function.py
          echo "# Section 3: Extensions" >> deploy_package/lambda_function.py
          echo "# ======================================================================" >> deploy_package/lambda_function.py

          # Extension enable flags from workflow inputs
          EXT_SECURITY="${{ inputs.ext_security }}"

          # Default to true if not specified (for manual runs without inputs)
          EXT_SECURITY="${EXT_SECURITY:-true}"

          echo "Extension flags: security=$EXT_SECURITY"

          # Security extension
          if [ "$EXT_SECURITY" == "true" ]; then
            echo "" >> deploy_package/lambda_function.py
            echo "# --- Extension: _ext_security.py ---" >> deploy_package/lambda_function.py
            cat "$EXT_DIR/_ext_security.py" >> deploy_package/lambda_function.py
            echo "  [INCLUDED] _ext_security.py"
          else
            echo "  [EXCLUDED] _ext_security.py"
          fi

          echo "" >> deploy_package/lambda_function.py

          # 4. Append AWS Lambda specific handler code
          echo "# ======================================================================" >> deploy_package/lambda_function.py
          echo "# Section 4: AWS Lambda Handler (Platform Specific)" >> deploy_package/lambda_function.py
          echo "# ======================================================================" >> deploy_package/lambda_function.py
          cat "$SRC_DIR/_03_aws_lambda_handler.py" >> deploy_package/lambda_function.py

          # Verify the merged file
          echo "=== Merged lambda_function.py statistics ==="
          wc -l deploy_package/lambda_function.py
          echo ""
          echo "=== Registered extensions ==="
          grep -E "^EXTENSION_NAME\s*=" "$EXT_DIR"/_ext_*.py 2>/dev/null || echo "No extensions found"
          echo ""
          head -60 deploy_package/lambda_function.py

      # 2. AWS auth (OIDC)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.EO_LAMBDA_DEPLOY_AWS_APNE1_ROLE_FOR_GITHUB }}
          aws-region: ap-northeast-1

      # 3. Lambda Deploy
      - name: Deploy to Lambda
        uses: aws-actions/aws-lambda-deploy@v1.1.0
        with:
          function-name: ${{ env.LAMBDA_FUNCTION_NAME }}
          code-artifacts-dir: ./deploy_package
          handler: lambda_function.lambda_handler
          runtime: python${{ env.PYTHON_VERSION }}
