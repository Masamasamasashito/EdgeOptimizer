name: Deploy GCP Cloud Run ane1

on:
#   push:
#     paths:
#       - 'RequestEngine/gcp_cloudrun/ane1/funcfiles/**'
#       - 'RequestEngine/common/**'
#     branches:
#       - main
  workflow_dispatch:
    inputs:
      ext_measure:
        description: 'Enable measure extension (eo.measure.*)'
        required: false
        default: true
        type: boolean
      ext_performance:
        description: 'Enable performance extension (eo.performance.*)'
        required: false
        default: true
        type: boolean
      ext_security:
        description: 'Enable security extension (eo.security.*)'
        required: false
        default: true
        type: boolean

permissions:
  id-token: write # OIDC認証に必須
  contents: read  # リポジトリの読み取りに必須

env:
  EO_GCP_PROJECT_ID: ${{ secrets.EO_GCP_PROJECT_ID }}
  EO_GCP_REGION: asia-northeast1
  EO_GCP_CLOUD_RUN_SERVICE_NAME: eo-re-d01-cloudrun-ane1
  EO_GCP_CLOUD_RUN_SERVICE_ACCOUNT_EMAIL: ${{ secrets.EO_GCP_RUN_ANE1_RUNTIME_SA_EMAIL }}
  EO_CLOUDRUN_REQUEST_SECRET_NAME: eo-re-d01-secretmng
  # Cloud Run スペック（RequestEngine/gcp_cloudrun/terraform/variables.tf デフォルト値にあわせた）
  EO_GCP_CLOUD_RUN_MEMORY: '512Mi'
  EO_GCP_CLOUD_RUN_CPU: '1'
  EO_GCP_CLOUD_RUN_TIMEOUT: '300'
  EO_GCP_CLOUD_RUN_MAX_INSTANCES: '10'
  EO_GCP_CLOUD_RUN_MIN_INSTANCES: '0'
  EO_GCP_CLOUD_RUN_PORT: '8080'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # 1. Create deployment package by merging modular source files
      - name: Merge GCP Cloud Run Files
        run: |
          mkdir -p deploy_package
          SRC_DIR="RequestEngine/gcp_cloudrun/ane1/funcfiles"
          COMMON_DIR="RequestEngine/common"
          EXT_DIR="RequestEngine/common/extensions"

          # Create header comment
          {
            echo "# ----------------------------------------------------"
            echo "# AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY"
            echo "# ----------------------------------------------------"
            echo "# This file is automatically generated during deployment by merging:"
            echo "# 1. _01_imports.py (common imports)"
            echo "# 2. request_engine_core.py (shared core functions)"
            echo "# 3. extensions/_ext_*.py (extension modules)"
            echo "# 4. _03_gcp_cloudrun_handler.py (GCP Cloud Run specific code)"
            echo "#"
            echo "# To make changes, edit the source files and redeploy."
            echo "# ----------------------------------------------------"
            echo ""
          } > deploy_package/main.py

          # 1. Append common imports
          echo "# ======================================================================" >> deploy_package/main.py
          echo "# Section 1: Common Imports" >> deploy_package/main.py
          echo "# ======================================================================" >> deploy_package/main.py
          cat "$SRC_DIR/_01_imports.py" >> deploy_package/main.py
          echo "" >> deploy_package/main.py

          # 2. Append common core code (shared across all platforms)
          echo "# ======================================================================" >> deploy_package/main.py
          echo "# Section 2: Request Engine Core (Shared Code)" >> deploy_package/main.py
          echo "# ======================================================================" >> deploy_package/main.py
          cat "$COMMON_DIR/request_engine_core.py" >> deploy_package/main.py
          echo "" >> deploy_package/main.py

          # 3. Append extension modules (only enabled ones)
          echo "# ======================================================================" >> deploy_package/main.py
          echo "# Section 3: Extensions" >> deploy_package/main.py
          echo "# ======================================================================" >> deploy_package/main.py

          # Extension enable flags from workflow inputs
          EXT_MEASURE="${{ inputs.ext_measure }}"
          EXT_PERFORMANCE="${{ inputs.ext_performance }}"
          EXT_SECURITY="${{ inputs.ext_security }}"

          # Default to true if not specified (for manual runs without inputs)
          EXT_MEASURE="${EXT_MEASURE:-true}"
          EXT_PERFORMANCE="${EXT_PERFORMANCE:-true}"
          EXT_SECURITY="${EXT_SECURITY:-true}"

          echo "Extension flags: measure=$EXT_MEASURE, performance=$EXT_PERFORMANCE, security=$EXT_SECURITY"

          # Measure extension
          if [ "$EXT_MEASURE" == "true" ]; then
            echo "" >> deploy_package/main.py
            echo "# --- Extension: _ext_measure.py ---" >> deploy_package/main.py
            cat "$EXT_DIR/_ext_measure.py" >> deploy_package/main.py
            echo "  [INCLUDED] _ext_measure.py"
          else
            echo "  [EXCLUDED] _ext_measure.py"
          fi

          # Performance extension
          if [ "$EXT_PERFORMANCE" == "true" ]; then
            echo "" >> deploy_package/main.py
            echo "# --- Extension: _ext_performance.py ---" >> deploy_package/main.py
            cat "$EXT_DIR/_ext_performance.py" >> deploy_package/main.py
            echo "  [INCLUDED] _ext_performance.py"
          else
            echo "  [EXCLUDED] _ext_performance.py"
          fi

          # Security extension
          if [ "$EXT_SECURITY" == "true" ]; then
            echo "" >> deploy_package/main.py
            echo "# --- Extension: _ext_security.py ---" >> deploy_package/main.py
            cat "$EXT_DIR/_ext_security.py" >> deploy_package/main.py
            echo "  [INCLUDED] _ext_security.py"
          else
            echo "  [EXCLUDED] _ext_security.py"
          fi

          echo "" >> deploy_package/main.py

          # 4. Append GCP Cloud Run specific handler code
          echo "# ======================================================================" >> deploy_package/main.py
          echo "# Section 4: GCP Cloud Run Handler (Platform Specific)" >> deploy_package/main.py
          echo "# ======================================================================" >> deploy_package/main.py
          cat "$SRC_DIR/_03_gcp_cloudrun_handler.py" >> deploy_package/main.py

          # Copy other required files to deploy_package
          cp "$SRC_DIR/requirements.txt" deploy_package/
          cp "$SRC_DIR/Procfile" deploy_package/

          # Verify the merged file
          echo "=== Merged main.py statistics ==="
          wc -l deploy_package/main.py
          echo ""
          echo "=== Registered extensions ==="
          grep -E "^EXTENSION_NAME\s*=" "$EXT_DIR"/_ext_*.py 2>/dev/null || echo "No extensions found"
          echo ""
          head -60 deploy_package/main.py

      # GCP auth (OIDC)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.EO_GCP_WIF_PROVIDER_PATH }}
          service_account: ${{ secrets.EO_GCP_RUN_ANE1_DEPLOY_SA_EMAIL }}
          audience: ${{ secrets.EO_GCP_WIF_PROVIDER_PATH }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Debug gcloud auth and config
        run: |
          set -x
          echo "=== gcloud version ==="
          gcloud --version

          echo "=== gcloud info (no diagnostics) ==="
          gcloud info

          echo "=== gcloud auth list ==="
          gcloud auth list

          echo "=== gcloud config list ==="
          gcloud config list

          echo "=== Impersonation / credentials related envs ==="
          echo "EO_GCP_RUN_ANE1_DEPLOY_SA_EMAIL=${{ secrets.EO_GCP_RUN_ANE1_DEPLOY_SA_EMAIL }}"
          echo "EO_GCP_CLOUD_RUN_SERVICE_ACCOUNT_EMAIL=${EO_GCP_CLOUD_RUN_SERVICE_ACCOUNT_EMAIL}"
          echo "GOOGLE_GHA_CREDS_PATH=${GOOGLE_GHA_CREDS_PATH}"
          echo "GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}"
          echo "CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=${CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE}"

          echo "=== Env overview (Cloud Run related) ==="
          echo "EO_GCP_PROJECT_ID=${EO_GCP_PROJECT_ID}"
          echo "EO_GCP_REGION=${EO_GCP_REGION}"
          echo "EO_GCP_CLOUD_RUN_SERVICE_NAME=${EO_GCP_CLOUD_RUN_SERVICE_NAME}"
          echo "EO_GCP_CLOUD_RUN_SERVICE_ACCOUNT_EMAIL=${EO_GCP_CLOUD_RUN_SERVICE_ACCOUNT_EMAIL}"

      # Deploy to Cloud Run from source
      # Cloud Build will automatically detect Python and build the container
      - name: Deploy to Cloud Run from source
        run: |
          set -x

          # ============================================================================
          # デバッグコード（削除可能）
          # ============================================================================
          echo "=== Before deploy: gcloud auth list ==="
          gcloud auth list

          echo "=== Before deploy: gcloud config list ==="
          gcloud config list

          # ============================================================================
          # 【絶対削除禁止】シークレット参照削除処理
          # ============================================================================
          # 重要: このセクションは削除しないでください。
          # CLOUDRUN_REQUEST_SECRET_NAMEが既にSecret Manager参照として設定されている場合、
          # 文字列リテラルに変更する際に型競合エラーが発生します。
          # そのため、先にシークレット参照と環境変数の両方を削除してから再設定する必要があります。
          # ============================================================================
          echo "=== Step 1a: Remove existing CLOUDRUN_REQUEST_SECRET_NAME secret reference ==="
          gcloud run services update ${{ env.EO_GCP_CLOUD_RUN_SERVICE_NAME }} \
            --region ${{ env.EO_GCP_REGION }} \
            --platform managed \
            --remove-secrets "CLOUDRUN_REQUEST_SECRET_NAME" \
            --project ${{ env.EO_GCP_PROJECT_ID }} || true

          echo "=== Step 1b: Remove existing CLOUDRUN_REQUEST_SECRET_NAME env var ==="
          gcloud run services update ${{ env.EO_GCP_CLOUD_RUN_SERVICE_NAME }} \
            --region ${{ env.EO_GCP_REGION }} \
            --platform managed \
            --remove-env-vars "CLOUDRUN_REQUEST_SECRET_NAME" \
            --project ${{ env.EO_GCP_PROJECT_ID }} || true
          # ============================================================================
          # 【絶対削除禁止】セクション終了
          # ============================================================================

          echo "=== Step 2: Deploy to Cloud Run with new env vars ==="
          gcloud --verbosity=debug --log-http run deploy ${{ env.EO_GCP_CLOUD_RUN_SERVICE_NAME }} \
            --source ./deploy_package \
            --region ${{ env.EO_GCP_REGION }} \
            --platform managed \
            --set-env-vars "EO_GCP_PROJECT_ID=${{ env.EO_GCP_PROJECT_ID }},CLOUDRUN_REQUEST_SECRET_NAME=${{ env.EO_CLOUDRUN_REQUEST_SECRET_NAME }}" \
            --memory ${{ env.EO_GCP_CLOUD_RUN_MEMORY }} \
            --cpu ${{ env.EO_GCP_CLOUD_RUN_CPU }} \
            --timeout ${{ env.EO_GCP_CLOUD_RUN_TIMEOUT }} \
            --max-instances ${{ env.EO_GCP_CLOUD_RUN_MAX_INSTANCES }} \
            --min-instances ${{ env.EO_GCP_CLOUD_RUN_MIN_INSTANCES }} \
            --port ${{ env.EO_GCP_CLOUD_RUN_PORT }} \
            --project ${{ env.EO_GCP_PROJECT_ID }} \
            --service-account ${{ env.EO_GCP_CLOUD_RUN_SERVICE_ACCOUNT_EMAIL }}

      - name: Get service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.EO_GCP_CLOUD_RUN_SERVICE_NAME }} \
            --region ${{ env.EO_GCP_REGION }} \
            --format 'value(status.url)' \
            --project ${{ env.EO_GCP_PROJECT_ID }})
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: Output service URL
        run: |
          echo "Cloud Run service deployed successfully!"
          echo "Service URL: ${{ steps.get-url.outputs.url }}"
