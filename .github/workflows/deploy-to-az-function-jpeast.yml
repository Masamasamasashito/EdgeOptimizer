name: Deploy Azure Functions jpeast

on:
#   push:
#     paths:
#       - 'RequestEngine/azure_functions/jpeast/funcfiles/**'
#       - 'RequestEngine/common/**'
#     branches:
#       - main
  workflow_dispatch:
    inputs:
      ext_security:
        description: 'Enable security extension (eo.security.*)'
        required: false
        default: true
        type: boolean

permissions:
  id-token: write # OIDC認証に必須
  contents: read  # リポジトリの読み取りに必須

env:
  PYTHON_VERSION: "3.13"
  FUNCTION_APP_NAME: eo-re-d01-funcapp-jpeast
  RESOURCE_GROUP: eo-re-d01-resource-group-jpeast

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # 1. Create deployment package by merging modular source files
      - name: Merge Azure Function Files
        run: |
          mkdir -p deploy_package
          SRC_DIR="RequestEngine/azure_functions/jpeast/funcfiles"
          COMMON_DIR="RequestEngine/common"
          EXT_DIR="RequestEngine/common/extensions"

          # Create header comment
          {
            echo "# ----------------------------------------------------"
            echo "# AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY"
            echo "# ----------------------------------------------------"
            echo "# This file is automatically generated during deployment by merging:"
            echo "# 1. _01_imports.py (common imports)"
            echo "# 2. request_engine_core.py (shared core functions)"
            echo "# 3. extensions/_ext_*.py (extension modules)"
            echo "# 4. _03_azure_handler.py (Azure Functions specific code)"
            echo "#"
            echo "# To make changes, edit the source files and redeploy."
            echo "# ----------------------------------------------------"
            echo ""
          } > deploy_package/function_app.py

          # 1. Append common imports
          echo "# ======================================================================" >> deploy_package/function_app.py
          echo "# Section 1: Common Imports" >> deploy_package/function_app.py
          echo "# ======================================================================" >> deploy_package/function_app.py
          cat "$SRC_DIR/_01_imports.py" >> deploy_package/function_app.py
          echo "" >> deploy_package/function_app.py

          # 2. Append common core code (shared across all platforms)
          echo "# ======================================================================" >> deploy_package/function_app.py
          echo "# Section 2: Request Engine Core (Shared Code)" >> deploy_package/function_app.py
          echo "# ======================================================================" >> deploy_package/function_app.py
          cat "$COMMON_DIR/request_engine_core.py" >> deploy_package/function_app.py
          echo "" >> deploy_package/function_app.py

          # 3. Append extension modules (only enabled ones)
          echo "# ======================================================================" >> deploy_package/function_app.py
          echo "# Section 3: Extensions" >> deploy_package/function_app.py
          echo "# ======================================================================" >> deploy_package/function_app.py

          # Extension enable flags from workflow inputs
          EXT_SECURITY="${{ inputs.ext_security }}"

          # Default to true if not specified (for manual runs without inputs)
          EXT_SECURITY="${EXT_SECURITY:-true}"

          echo "Extension flags: security=$EXT_SECURITY"

          # Security extension
          if [ "$EXT_SECURITY" == "true" ]; then
            echo "" >> deploy_package/function_app.py
            echo "# --- Extension: _ext_security.py ---" >> deploy_package/function_app.py
            cat "$EXT_DIR/_ext_security.py" >> deploy_package/function_app.py
            echo "  [INCLUDED] _ext_security.py"
          else
            echo "  [EXCLUDED] _ext_security.py"
          fi

          echo "" >> deploy_package/function_app.py

          # 4. Append Azure Functions specific handler code
          echo "# ======================================================================" >> deploy_package/function_app.py
          echo "# Section 4: Azure Functions Handler (Platform Specific)" >> deploy_package/function_app.py
          echo "# ======================================================================" >> deploy_package/function_app.py
          cat "$SRC_DIR/_03_azure_handler.py" >> deploy_package/function_app.py

          # Copy other required files to deploy_package
          cp "$SRC_DIR/requirements.txt" deploy_package/
          cp "$SRC_DIR/host.json" deploy_package/

          # Verify the merged file
          echo "=== Merged function_app.py statistics ==="
          wc -l deploy_package/function_app.py
          echo ""
          echo "=== Registered extensions ==="
          grep -E "^EXTENSION_NAME\s*=" "$EXT_DIR"/_ext_*.py 2>/dev/null || echo "No extensions found"
          echo ""
          head -60 deploy_package/function_app.py

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: ./deploy_package
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # Create local.settings.json with EO_AZ_RE_KEYVAULT_URL
      - name: Create local.settings.json
        working-directory: ./deploy_package
        run: |
          cat > local.settings.json << 'EOF'
          {
            "IsEncrypted": false,
            "Values": {
              "FUNCTIONS_WORKER_RUNTIME": "python",
              "AzureWebJobsStorage": "UseDevelopmentStorage=true",
              "EO_AZ_RE_KEYVAULT_URL": "${{ secrets.EO_AZ_RE_KEYVAULT_URL }}"
            }
          }
          EOF

      # Install Azure Functions Core Tools (required for Python v2 model)
      - name: Install Azure Functions Core Tools
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
          sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/dotnetdev.list'
          sudo apt-get update
          sudo apt-get install -y azure-functions-core-tools-4

      # Azure auth (OIDC)
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.EO_AZ_FUNC_JPEAST_DEPLOY_ENTRA_APP_ID_FOR_GITHUB }}
          tenant-id: ${{ secrets.EO_AZ_TENANT_ID }}
          subscription-id: ${{ secrets.EO_AZURE_SUBSCRIPTION_ID }}

      # Deploy to Azure Functions using func command (Python v2 model)
      - name: Deploy to Azure Functions
        working-directory: ./deploy_package
        run: |
          func azure functionapp publish ${{ env.FUNCTION_APP_NAME }} --python

          # Set EO_AZ_RE_KEYVAULT_URL app setting explicitly
          if [ -n "${{ secrets.EO_AZ_RE_KEYVAULT_URL }}" ]; then
            az functionapp config appsettings set \
              --name ${{ env.FUNCTION_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --settings "EO_AZ_RE_KEYVAULT_URL=${{ secrets.EO_AZ_RE_KEYVAULT_URL }}" \
              --output none
          fi
