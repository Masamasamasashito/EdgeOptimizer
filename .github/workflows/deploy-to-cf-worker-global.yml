name: Deploy CloudFlare Worker Global

on:
#   push:
#     paths:
#       - 'RequestEngine/cloudflare_workers/global/funcfiles/src/**'
#       - 'RequestEngine/cloudflare_workers/global/funcfiles/wrangler.toml'
#       - 'RequestEngine/cloudflare_workers/global/funcfiles/package.json'
#       - 'RequestEngine/cloudflare_workers/global/funcfiles/package-lock.json'
#       - 'RequestEngine/cloudflare_workers/global/funcfiles/tsconfig.json'
#       - 'RequestEngine/cloudflare_workers/global/funcfiles/build.mjs'
#       # if you want to trigger workflow when you change deploy-to-cf-worker-global.yml
#       # - '.github/workflows/deploy-to-cf-worker-global.yml'

  workflow_dispatch:
    inputs:
      ext_security:
        description: 'Enable security extension (eo.security.*)'
        required: false
        default: true
        type: boolean

jobs:
  cf_worker_deploy: # ジョブ名（任意）。実行単位の論理名
    # GitHub-hosted Runner(JOB実行するマシン(コンテナ))の実行環境が割り当てられる(送信元IPアドレス固定できない)
    runs-on: ubuntu-latest
    timeout-minutes: 10 # ジョブ全体の実行上限時間。ハング防止
    permissions: # 最小権限の原則。GITHUB_TOKEN のスコープを制限
      contents: read # リポジトリの「読み取りのみ」許可（push/Release作成等は不可）
    concurrency: # 二重実行の制御（最新コミットだけをデプロイしたい時に有効）
      # 同じ group 名のジョブは同時実行しない。workflow名＋ブランチ/タグでグループ化
      group: deploy-worker-${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true # 新しい実行が来たら古い実行を自動キャンセル
    steps:
      # Checkout the latest code,Get Repository on Runner.以降のステップがソースにアクセス可能になる
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: ./RequestEngine/cloudflare_workers/global/funcfiles
        run: npm install

      - name: Generate _02_extensions.ts (conditional extension imports)
        run: |
          EXT_FILE="RequestEngine/cloudflare_workers/global/funcfiles/src/_02_extensions.ts"
          EXT_SECURITY="${{ inputs.ext_security }}"
          EXT_SECURITY="${EXT_SECURITY:-true}"

          echo "Extension flags: security=$EXT_SECURITY"

          # Generate header
          {
            echo '// Auto-generated by deploy-to-cf-worker-global.yml'
            echo '// Extension imports that register themselves with the extension registry.'
            echo '// Matches Python: GitHub Actions cat-merge of extensions/_ext_*.py'
            echo ''
          } > "$EXT_FILE"

          # Security extension
          if [ "$EXT_SECURITY" == "true" ]; then
            echo 'import "../../../common/extensions/_ext_security";' >> "$EXT_FILE"
            echo "  [INCLUDED] _ext_security.ts"
          else
            echo "  [EXCLUDED] _ext_security.ts"
          fi

          echo ""
          echo "=== Generated _02_extensions.ts ==="
          cat "$EXT_FILE"

      - name: Build worker (strip comments only, no minify)
        working-directory: ./RequestEngine/cloudflare_workers/global/funcfiles
        run: npm run build

      - name: Generate wrangler.toml
        working-directory: ./RequestEngine/cloudflare_workers/global/funcfiles
        run: |
          cat <<EOF > wrangler.toml
          name = "eo-re-d01-cfworker-global"
          main = "src/worker.ts"
          compatibility_date = "2026-01-13"
          workers_dev = false
          preview_urls = false

          [observability]
          enabled = false
          head_sampling_rate = 1

          [observability.logs]
          enabled = true
          head_sampling_rate = 1
          persist = true
          invocation_logs = true

          [observability.traces]
          enabled = false
          persist = true
          head_sampling_rate = 1
          EOF

      - name: Deploy to Cloudflare Worker Global
        uses: cloudflare/wrangler-action@v3
        with:
          wranglerVersion: '4.64.0'
          apiToken: ${{ secrets.EO_CF_WORKER_USER_API_TOKEN_FOR_GITHUB }}
          accountId: ${{ secrets.EO_CF_ACCOUNT_ID }}
          workingDirectory: ./RequestEngine/cloudflare_workers/global/funcfiles
          command: deploy
