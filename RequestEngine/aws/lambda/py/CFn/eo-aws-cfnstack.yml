# Request Engine Instance config: ../instances_conf/lambda001.env
AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Edge Optimizer - AWS Lambda Request Engine Infrastructure
  Creates Lambda function, IAM roles/policies, Secrets Manager, and GitHub Actions OIDC integration

# ==============================================================================
# PREREQUISITES (Must be created BEFORE deploying this stack)
# ==============================================================================
# 1. Lambda Layer:
#    Create the Lambda Layer manually before deploying this stack.
#    Layer ARN format: arn:aws:{EoServerlessService}:{EoRegion}:{AWSAccountId}:layer:{EoProject}-{EoComponent}-{EoEnv}-{EoServerlessService}-py314-slim-layer:{Version}
#    Example: arn:aws:lambda:ap-northeast-1:123456789012:layer:eo-re-d1-lambda-python-slim-layer:1
#    See: EO_Documents/Manuals/py/LAMBDA_README.md (Section 8-9) for layer creation steps.
#
# 2. GitHub OIDC Provider (IMPORTANT):
#    If your AWS account already has a GitHub OIDC Provider (token.actions.githubusercontent.com),
#    you must REMOVE the GitHubOIDCProvider resource from this template to avoid duplicate error.
#    Check: IAM > Identity providers > token.actions.githubusercontent.com
#
# ==============================================================================
# POST-DEPLOYMENT STEPS
# ==============================================================================
# 1. Update Secrets Manager value:
#    Replace "REPLACE_WITH_N8N_EO_REQUEST_SECRET" with actual N8N_EO_REQUEST_SECRET from EO_Infra_Docker/.env
#
# 2. Create IAM Access Key for n8n (manual creation recommended for security):
#    IAM Console > Users > {EoProject}-{EoComponent}-{EoEnv}-{EoServerlessService}-{EoRegionShort}-iamu > Security credentials > Create access key
#
# 3. Set GitHub Secrets:
#    Add GitHubActionsDeployRoleArn output value to GitHub repository secrets
#
# ==============================================================================

# ==============================================================================
# Metadata - Parameter Groups for Console Display
# ==============================================================================
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Naming Convention Parameters"
        Parameters:
          - EoProject
          - EoComponent
          - EoEnv
          - EoRegionShort
          - EoServerlessService
          - EoSecretService
          - EoLambdaRequestSecretName
      - Label:
          default: "AWS Account Settings"
        Parameters:
          - AWSAccountId
          - EoRegion
      - Label:
          default: "Lambda Settings"
        Parameters:
          - EoRePythonRuntimeVer
          - EoReLambdaLayerName
          - EoReLambdaLayerVer
          - EoReLambdaTimeout
          - EoReLambdaMemorySize
      - Label:
          default: "GitHub Actions OIDC Settings"
        Parameters:
          - GitHubOrg
          - EoGitHubRepo
    ParameterLabels:
      EoProject:
        default: "Project Prefix (e.g., eo)"
      EoComponent:
        default: "EoComponent Identifier (e.g., re)"
      EoEnv:
        default: "EoEnv Identifier (e.g., d1, p1)"
      EoRegionShort:
        default: "Region Short Name (e.g., apne1)"
      EoServerlessService:
        default: "Serverless Service Identifier (lambda = AWS Lambda)"
      EoSecretService:
        default: "Secret Service Identifier (secretsmng = AWS Secrets Manager)"
      EoLambdaRequestSecretName:
        default: "Lambda Request Secret Name (Not Value)"
      AWSAccountId:
        default: "AWS Account ID"
      EoRegion:
        default: "AWS Region"
      EoRePythonRuntimeVer:
        default: "RequestEngine (Lambda) Python Runtime Version"
      EoReLambdaLayerName:
        default: "RequestEngine (Lambda) Layer Name (must exist before deployment)"
      EoReLambdaLayerVer:
        default: "RequestEngine (Lambda) Layer Version"
      EoReLambdaTimeout:
        default: "RequestEngine (Lambda) Timeout (min 30s recommended)"
      EoReLambdaMemorySize:
        default: "RequestEngine (Lambda) Memory Size (min 128MB recommended)"
      GitHubOrg:
        default: "GitHub Organization or Username"
      EoGitHubRepo:
        default: "GitHub Repository Name"

# ==============================================================================
# Parameters
# ==============================================================================
Parameters:
  # --- Naming Convention ---
  EoProject:
    Type: String
    Description: "Project prefix for resource naming"
    Default: "eo"
    AllowedPattern: "^[a-z0-9]+$"
    ConstraintDescription: "Lowercase alphanumeric only"

  EoComponent:
    Type: String
    Description: "EoComponent identifier (re = Request Engine)"
    Default: "re"
    AllowedPattern: "^[a-z0-9]+$"

  EoEnv:
    Type: String
    Description: "EoEnv identifier (d1 = dev01, p01 = prod01)"
    Default: "d1"
    AllowedPattern: "^[a-z0-9]+$"

  EoRegionShort:
    Type: String
    Description: "Short region name for resource naming"
    Default: "apne1"
    AllowedValues:
      - "apne1"   # ap-northeast-1 (Tokyo)
      - "apne2"   # ap-northeast-2 (Seoul)
      - "apne3"   # ap-northeast-3 (Osaka)
      - "apse1"   # ap-southeast-1 (Singapore)
      - "use1"    # us-east-1 (N. Virginia)
      - "usw2"    # us-west-2 (Oregon)
      - "euw1"    # eu-west-1 (Ireland)

  EoServerlessService:
    Type: String
    Description: "Serverless service identifier (lambda = Lambda)"
    Default: "lambda"
    AllowedValues:
      - "lambda"

  EoSecretService:
    Type: String
    Description: "Secret service identifier (secretsmng = Secrets Manager)"
    Default: "secretsmng"
    AllowedValues:
      - "secretsmng"

  EoLambdaRequestSecretName:
    Type: String
    Description: "Lambda request secret name"
    Default: "LAMBDA_REQUEST_SECRET"
    AllowedValues:
      - "LAMBDA_REQUEST_SECRET"

  # --- AWS Account ---
  AWSAccountId:
    Type: String
    Description: "AWS Account ID"
    NoEcho: true
    AllowedPattern: "^[0-9]{12}$"
    ConstraintDescription: "Must be a 12-digit AWS Account ID"

  EoRegion:
    Type: String
    Description: "Target AWS Region"
    Default: "ap-northeast-1"
    AllowedValues:
      - "ap-northeast-1"
      - "ap-northeast-2"
      - "ap-northeast-3"
      - "ap-southeast-1"
      - "us-east-1"
      - "us-west-2"
      - "eu-west-1"

  # --- Lambda Settings ---
  EoRePythonRuntimeVer:
    Type: String
    Description: "Python runtime version"
    Default: "python3.14"
    AllowedValues:
      - "python3.11"
      - "python3.12"
      - "python3.13"
      - "python3.14"

  EoReLambdaLayerName:
    Type: String
    Description: "Lambda Layer name (MUST exist before deployment). Example: eo-re-d1-lambda-python-slim-layer"
    Default: "eo-re-d1-lambda-python-slim-layer"

  EoReLambdaLayerVer:
    Type: Number
    Description: "Lambda Layer version number"
    Default: 1
    MinValue: 1

  EoReLambdaTimeout:
    Type: Number
    Description: "Lambda timeout in seconds (min 30s recommended)"
    Default: 30
    MinValue: 3
    MaxValue: 900

  EoReLambdaMemorySize:
    Type: Number
    Description: "Lambda memory size in MB"
    Default: 128
    AllowedValues:
      - 128
      - 256
      - 512
      - 1024

  # --- GitHub Actions OIDC ---
  GitHubOrg:
    Type: String
    Description: "GitHub organization or username"
    Default: "your-github-org"

  EoGitHubRepo:
    Type: String
    Description: "GitHub repository name"
    Default: "your-repo-name"

# ==============================================================================
# Resources
# ==============================================================================
Resources:

  # ============================================================================
  # CloudWatch Logs - Lambda Log Group (Retention: 1 day)
  # ============================================================================
  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      LogGroupName: !Sub "/aws/${EoServerlessService}/${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}"
      RetentionInDays: 1
      Tags:
        - Key: Name
          Value: !Sub "/aws/${EoServerlessService}/${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}"
        - Key: Project
          Value: !Ref EoProject
        - Key: EoEnv
          Value: !Ref EoEnv

  # ============================================================================
  # Secrets Manager - Request Secret for Token Verification
  # ============================================================================
  RequestSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Name: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoSecretService}-${EoRegionShort}"
      Description: "N8N Request Secret for token verification (LAMBDA_REQUEST_SECRET)"
      # POST-DEPLOYMENT: Update this value with N8N_EO_REQUEST_SECRET from EO_Infra_Docker/.env
      SecretString: !Sub '{"${EoLambdaRequestSecretName}": "REPLACE_WITH_N8N_EO_REQUEST_SECRET"}'
      Tags:
        - Key: Name
          Value: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoSecretService}-${EoRegionShort}"
        - Key: Project
          Value: !Ref EoProject
        - Key: EoEnv
          Value: !Ref EoEnv

  # ============================================================================
  # IAM - Lambda Execution Role
  # ============================================================================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      RoleName: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-role"
      Path: "/service-role/"
      MaxSessionDuration: 3600
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref LambdaBasicExecutionPolicy
        - !Ref LambdaSecretsAccessPolicy
      Tags:
        - Key: Name
          Value: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-role"

  # --- Lambda Basic Execution Policy (CloudWatch Logs) ---
  LambdaBasicExecutionPolicy:
    Type: AWS::IAM::ManagedPolicy
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      ManagedPolicyName: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-basic-exec-iamp"
      Path: "/service-role/"
      Description: "Basic execution policy for Lambda (CloudWatch Logs)"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action: logs:CreateLogGroup
            Resource: !Sub "arn:aws:logs:${EoRegion}:${AWSAccountId}:*"
          - Effect: Allow
            Action:
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource:
              - !Sub "arn:aws:logs:${EoRegion}:${AWSAccountId}:log-group:/aws/${EoServerlessService}/${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}:*"

  # --- Lambda Secrets Manager Access Policy ---
  LambdaSecretsAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      ManagedPolicyName: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-role-iamp"
      Path: "/"
      Description: "Policy to allow Lambda to read request secret from Secrets Manager"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowReadRequestSecret
            Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${EoRegion}:${AWSAccountId}:secret:${EoProject}-${EoComponent}-${EoEnv}-${EoSecretService}-${EoRegionShort}-*"

  # ============================================================================
  # IAM - n8n Access Key User (for Lambda Invocation)
  # POST-DEPLOYMENT: Create Access Key manually via IAM Console for security
  # ============================================================================
  N8nAccessKeyUser:
    Type: AWS::IAM::User
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      UserName: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-iamu"
      Path: "/"
      ManagedPolicyArns:
        - !Ref N8nLambdaInvokePolicy
      Tags:
        - Key: Name
          Value: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-iamu"

  # --- n8n Lambda Invoke Policy ---
  N8nLambdaInvokePolicy:
    Type: AWS::IAM::ManagedPolicy
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      ManagedPolicyName: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-access-key-iamp"
      Path: "/"
      Description: "Policy for n8n to invoke Lambda function via Access Key"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - !Sub "${EoServerlessService}:InvokeFunction"
            Resource:
              - !Sub "arn:aws:${EoServerlessService}:${EoRegion}:${AWSAccountId}:function:${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}"
              - !Sub "arn:aws:${EoServerlessService}:${EoRegion}:${AWSAccountId}:function:${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}:*"

  # ============================================================================
  # IAM - GitHub Actions OIDC Provider
  # WARNING: If this OIDC Provider already exists in your account, COMMENT OUT:
  #   1. This "GitHubOIDCProvider" resource (below)
  #   2. The "GitHubOIDCProviderArn" output (at the bottom of this file)
  # to avoid "EntityAlreadyExists" error. Only ONE provider per URL per account.
  # Check: IAM Console > Identity providers > token.actions.githubusercontent.com
  # ============================================================================
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Url: "https://token.actions.githubusercontent.com"
      ClientIdList:
        - "sts.amazonaws.com"
      ThumbprintList:
        - "2b18947a6a9fc7764fd8b5fb18a863b0c6dac24f"
      Tags:
        - Key: Name
          Value: !Sub "${EoProject}-ghactions-idp-request-engine-${EoServerlessService}-aws-${EoRegionShort}"

  # --- GitHub Actions Deploy Role ---
  GitHubActionsDeployRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      RoleName: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-ghactions-deploy-iamr"
      Path: "/"
      MaxSessionDuration: 3600
      Description: "Role for GitHub Actions to deploy Lambda function"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Sub "arn:aws:iam::${AWSAccountId}:oidc-provider/token.actions.githubusercontent.com"
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
              StringLike:
                "token.actions.githubusercontent.com:sub":
                  - !Sub "repo:${GitHubOrg}/${EoGitHubRepo}:*"
      ManagedPolicyArns:
        - !Ref GitHubActionsDeployPolicy
      Tags:
        - Key: Name
          Value: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-ghactions-deploy-iamr"

  # --- GitHub Actions Deploy Policy ---
  GitHubActionsDeployPolicy:
    Type: AWS::IAM::ManagedPolicy
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      ManagedPolicyName: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}-ghactions-deploy-iamr-iamp"
      Path: "/"
      Description: "Policy for GitHub Actions to deploy Lambda function"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: LambdaDeploymentPermissions
            Effect: Allow
            Action:
              - lambda:GetFunctionConfiguration
              - lambda:UpdateFunctionCode
              - lambda:UpdateFunctionConfiguration
              - lambda:GetFunction
            Resource: !Sub "arn:aws:${EoServerlessService}:${EoRegion}:${AWSAccountId}:function:${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}"

  # ============================================================================
  # Lambda Function
  # PREREQUISITE: Lambda Layer must exist before deployment
  # ============================================================================
  LambdaFunction:
    Type: AWS::Lambda::Function
    DependsOn: LambdaLogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      FunctionName: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}"
      Description: "Edge Optimizer Request Engine - Lambda"
      Runtime: !Ref EoRePythonRuntimeVer
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      MemorySize: !Ref EoReLambdaMemorySize
      Timeout: !Ref EoReLambdaTimeout
      Architectures:
        - x86_64
      PackageType: Zip
      # Hello World placeholder - will be replaced by GitHub Actions deployment
      Code:
        ZipFile: |
          import json

          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'Hello World from Edge Optimizer!'})
              }
      # PREREQUISITE: Create this layer before deploying the stack
      # See: EO_Documents/Manuals/py/LAMBDA_README.md
      Layers:
        - !Sub "arn:aws:${EoServerlessService}:${EoRegion}:${AWSAccountId}:layer:${EoReLambdaLayerName}:${EoReLambdaLayerVer}"
      LoggingConfig:
        LogFormat: Text
        LogGroup: !Ref LambdaLogGroup
      TracingConfig:
        Mode: PassThrough
      RuntimeManagementConfig:
        UpdateRuntimeOn: Auto
      EphemeralStorage:
        Size: 512
      RecursiveLoop: Terminate
      Tags:
        - Key: Name
          Value: !Sub "${EoProject}-${EoComponent}-${EoEnv}-${EoServerlessService}-${EoRegionShort}"
        - Key: Project
          Value: !Ref EoProject
        - Key: EoEnv
          Value: !Ref EoEnv

# ==============================================================================
# Outputs
# ==============================================================================
Outputs:
  # --- Lambda ---
  LambdaFunctionArn:
    Description: "Lambda Function ARN"
    Value: !GetAtt LambdaFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-LambdaFunctionArn"

  LambdaFunctionName:
    Description: "Lambda Function Name"
    Value: !Ref LambdaFunction
    Export:
      Name: !Sub "${AWS::StackName}-LambdaFunctionName"

  LambdaExecutionRoleArn:
    Description: "Lambda Execution Role ARN"
    Value: !GetAtt LambdaExecutionRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-LambdaExecutionRoleArn"

  LambdaLogGroupName:
    Description: "Lambda Log Group Name"
    Value: !Ref LambdaLogGroup
    Export:
      Name: !Sub "${AWS::StackName}-LambdaLogGroupName"

  # --- Secrets Manager ---
  SecretArn:
    Description: "Secrets Manager Secret ARN (update value after deployment)"
    Value: !Ref RequestSecret
    Export:
      Name: !Sub "${AWS::StackName}-SecretArn"

  # --- n8n Access Key User ---
  N8nAccessKeyUserArn:
    Description: "IAM User ARN for n8n (create Access Key manually via IAM Console)"
    Value: !GetAtt N8nAccessKeyUser.Arn
    Export:
      Name: !Sub "${AWS::StackName}-N8nAccessKeyUserArn"

  N8nAccessKeyUserName:
    Description: "IAM User Name for n8n Access Key creation"
    Value: !Ref N8nAccessKeyUser
    Export:
      Name: !Sub "${AWS::StackName}-N8nAccessKeyUserName"

  # --- GitHub Actions ---
  GitHubActionsDeployRoleArn:
    Description: "GitHub Actions Deploy Role ARN (set this in GitHub Secrets as EO_LAMBDA_DEPLOY_AWS_APNE1_ROLE_FOR_GITHUB)"
    Value: !GetAtt GitHubActionsDeployRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GitHubActionsDeployRoleArn"

  GitHubOIDCProviderArn:
    Description: "GitHub OIDC Provider ARN"
    Value: !GetAtt GitHubOIDCProvider.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GitHubOIDCProviderArn"
